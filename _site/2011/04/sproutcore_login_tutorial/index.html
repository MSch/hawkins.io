<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>BroadcastingAdam - Sproutcore Login Tutorial</title>

    
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.2r1/build/reset/reset-min.css">
<link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />


    <script type="text/javascript" src="http://yandex.st/highlightjs/5.16/highlight.min.js"></script>
    <link rel="stylesheet" href="http://yandex.st/highlightjs/5.16/styles/github.min.css">
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="container">
      <header>
  <h1>BroadcastingAdam</h1>
  <a href="http://feeds.feedburner.com/BroadcastingAdam" id="rss"><img src="images/rss_icon.png" alt="rss" /></a>
  <nav>
    <a href="/">Home</a>
    <a href="/nettuts.html">Nettuts</a>
    <a href="/talks.html">Talks</a>
    <a href="/open_source.html">Open Source</a>
  </nav>
</header>


      <div id="content" class="post">
        <header >
          <h2>Sproutcore Login Tutorial</h2>
          <div class='meta'>
            </p>April 04, 2011 &nbsp; | &nbsp; sproutcore tutorials</p>
          </div>
        </header>
        <article>
          <p>Sproutcore is probably the coolest thing I&#8217;ve seen since I saw rails way back early in 2006. I think Sproutcore is the future of complex web application because it is an excellent way to create complicated (and elegant) UI&#8217;s using Javascript. It uses KVO (Key-Value-Observing) to keep the UI in sync with the model. Yehdua Katz put it this way: &#8220;the view always represents truth.&#8221; I will not write about Sproutcore (SC from now on) because there is plenty of information to read on what it is and how it works. They have a <a href='http://guides.sproutcore.com'>guides site</a> to learn about it. However, there is still a lot of confusion on how to implement some simple stuff in SC! I&#8217;ve been dabbling with SC for a few months now&#8211;and now I&#8217;m finally ready to pass on some knowledge. I write SaaS applications, so the first thing I ever consider is &#8220;the user has to login.&#8221; That was my first hurdle with SC. I had to solve this problem: &#8220;How can I create a login form with sproutcore and authenticate against a database of users?&#8221; Well in order to solve this problem we need to do a few things:</p>

<ol>
<li>Create an SC application with a form for username/password</li>

<li>Figure out how to submit that form</li>

<li>Create an HTTP API to determine if the form is valid</li>

<li>Return some information to SC</li>
</ol>

<p>We&#8217;ll start out by creating a basic interface. We&#8217;ll have two pages. When the user goes to our application they&#8217;ll see the login form. If they login correcly, we&#8217;ll show them a different view.</p>

<p>We need some way to get the data from the form to pass it off for processing. SC.ObjectController will do this for us. SC.ObjectController is a proxy to some underling object. However, we never bind directly to the object, instead we bind to the controller. That way when some information changes in the controller (and thusly the underlying object) the various things bound to it will change. This is where KVO comes into play.</p>

<p>We also need something to process the data in the form. The processing code works along these lines:</p>

<ol>
<li>Send a HTTP request to the server</li>

<li>Tell the UI to update according to the HTTP response</li>
</ol>

<p>We&#8217;ll use a state chart framework to transition the application from a logged out state to the logged in state. State charts are good way to model applications. I suggest you google them to learn more about them. Our simple application will only have 2 states: logged in/out.</p>

<p>Once we have the SC application working correclty with some mock login info, we&#8217;ll hook up a simple web service written with Sinatra.</p>

<h2 id='creating_the_sproutcore_application'>Creating the Sproutcore Application</h2>

<p>Sproutcore comes with some generators (similar to Rails). It has a generator to create a basic application. <strong>I am using Sproutcore 1.5RC1 for this.</strong> Ensure the proper version is installed. You can install the gem and generate a new application like this:</p>

<pre><code>$ # enter a fresh directory
$ rvm use 1.9.2@sproutcore-login-tutorial # if you want to use rvm
$ gem install sproutcore --pre
$ sc-init login_tutorial</code></pre>

<p>Now you can start the server and see a hello world page</p>

<pre><code>$ sc-server
# head over to localhost:4020 and choose &#39;login_tutorial&#39;</code></pre>

<p><img alt='Welcome' src='/images/posts/sproutcore_login_tutorial/welcome.png' /></p>

<h2 id='creating_the_login_page'>Creating the Login Page</h2>

<p>Take a peek at <code>apps/login_tutorial/main_page.js</code>. This file defines the intial view in our application. It creates a page with a label on it. Every <code>SC.Page</code> must have a <code>SC.MainPane</code> as the mainPane property. The mainPane contains the objects that are part of the view and displayed on the page. We&#8217;ll use this code as an example to create a new page that shows our login form. We&#8217;ll reserve the main page for the logged in state since it&#8217;s feasible to say that 99% of time the user is logged in.</p>

<p>Create a file named: <code>apps/login_tutorial/resource/login_page.js</code>.</p>

<p>Here is the skeleton:</p>

<pre><code>LoginTutorial.loginPage = SC.Page.design({
    mainPane: SC.MainPane.design({
    })
}); </code></pre>

<p>Inside the mainPane there will be view with 2 text feilds and a button to submit the form. Here is the scaffold code you can use to create the view:</p>

<pre><code>LoginTutorial.loginPage = SC.Page.design({
  mainPane: SC.MainPane.design({
    childViews: &#39;form&#39;.w(),

    form: SC.View.design({
      layout: { width: 200, height: 160, centerX: 0, centerY: 0 },
      childViews: &#39;header userName password loginButton&#39;.w(),

      header: SC.LabelView.design({
        layout: { width: 200, height: 24, top: 0, centerX: 0 },
        controlSize: SC.LARGE_CONTROL_SIZE,
        value: &#39;Login Required&#39;,
        textAlign: SC.ALIGN_CENTER
      }),

      userName: SC.TextFieldView.design({
        layout: { width: 150, height: 30, top: 30, centerX: 0},
        hint: &#39;Username&#39;
      }),

      password: SC.TextFieldView.design({
        layout: {  width: 150, height: 30, top: 80, centerX: 0 },
        hint: &#39;Password&#39;,
        isPassword: YES
      }),

      loginButton: SC.ButtonView.design({
        layout: { width: 100, height: 30, top: 120, centerX: 0 },
        conrolSize: SC.HUGE_CONTROL_SIZE,
        title: &#39;Login&#39;
      })
    })
  })
});</code></pre>

<p>We still have to connect the controller to the data and setup the state chart. Let&#8217;s do that next.</p>

<h2 id='configuring_the_state_chart'>Configuring the State Chart</h2>

<p>Firs, update the <code>Buildfile</code> in the root directory to require the state chart framework. Change the only line in the file to:</p>

<pre><code>config :all, :required =&gt; [:sproutcore, &#39;sproutcore/statechart&#39;]</code></pre>

<p>Now create a file named: <code>apps/login_tutorial/core_states.js</code>. This file defines the state chart. It will have 2 states: loggedIn and loggedOut. When we enter the logged out state, the login form will be displayed. The form will be removed when we leave the state. The main page will be displayed when we enter the logged in state. Here is the code:</p>

<pre><code>LoginTutorial.statechart = SC.Statechart.create({
  rootState: SC.State.design({
    initialSubstate: &#39;loggedOut&#39;,

    loggedOut: SC.State.design({
      enterState: function() {
        LoginTutorial.getPath(&#39;loginPage.mainPane&#39;).append();
      },

      exitState: function() {
        LoginTutorial.getPath(&#39;loginPage.mainPane&#39;).remove();
      }
    }),

    loggedIn: SC.State.design({
      enterState: function() {
        LoginTutorial.getPath(&#39;mainPage.mainPane&#39;).append();
      }
    })
  })
});</code></pre>

<p>The state chart is in charge of handling the flow of the application. It needs to be started when the user goes to the page. Open up <code>apps/login_tutorial/main.js</code> and replace the content of the <code>main</code> function with:</p>

<pre><code>LoginTutorial.main = function main() {

  LoginTutorial.statechart.initStatechart();

} ;</code></pre>

<p>Now, reboot the server and head back to the application. You should see a shiny login form.</p>

<p><img alt='Login Form' src='/images/posts/sproutcore_login_tutorial/login_form.png' /></p>

<h2 id='binding_with_a_controller'>Binding with a Controller</h2>

<p>Now we need to create a controller. A controller manages data for us. We&#8217;ll create a controller with two properties and bind them to the values in the login form. First generate a controller:</p>

<pre><code>$ sc-gen controller LoginTutorial.loginController</code></pre>

<p>Now create two attributes for the controller like so:</p>

<pre><code>LoginTutorial.loginController = SC.ObjectController.create(
/** @scope LoginTutorial.loginController.prototype */ {

  userName: null,
  password: null

}) ;</code></pre>

<p>Now we need to bind the controller to the inputs. We&#8217;ll set the <code>valueBinding</code> property on the text fields to the correct value on the controller. Then whenever the user types something in the form, the controller&#8217;s attributes will update. We&#8217;ll use the controller to get the data to actually login soon. Here is the code to bind the text fields to the controller:</p>

<pre><code>userName: SC.TextFieldView.design({
  layout: { width: 150, height: 30, top: 30, centerX: 0},
  hint: &#39;Username&#39;,
  valueBinding: &#39;LoginTutorial.loginController.userName&#39;
}),

password: SC.TextFieldView.design({
  layout: {  width: 150, height: 30, top: 80, centerX: 0 },
  hint: &#39;Password&#39;,
  isPassword: YES,
  valueBinding: &#39;LoginTutorial.loginController.password&#39;
}),</code></pre>

<p>Reload the page and now you can type stuff into the fields. Then you can check controller properties in the console. So for example, if you type &#8216;Adman65&#8217; into the user name field you could evaluate this in the console:</p>

<pre><code>&gt; LoginTutorial.loginController.userName
&quot;Adman65&quot;</code></pre>

<p>Conversely, you could also set the value of userName in the controller and it would update the UI:</p>

<pre><code>LoginTutorial.loginController.set(&#39;userName&#39;, &#39;rpm&#39;)</code></pre>

<h2 id='making_the_form_do_something'>Making the Form Do Something</h2>

<p>The next step is to make the login button do something. Pressing the button fires an event. We can configure the button to call a method on a responder. A responder is an object that knows how to handle the action. We can set the responder property on a view so all actions are processed by the same object. Our statechart is the responder for this example. Here is the strategy:</p>

<ol>
<li>Tell the view that state chart will handle events fired from it</li>

<li>Tell the button to call a method on the responder</li>

<li>Add a method to handle the action</li>

<li>Use that action to authenticate using the credentials</li>
</ol>

<p>Set the responder like this:</p>

<pre><code>LoginTutorial.loginPage = SC.Page.design({
  mainPane: SC.MainPane.design({
    defaultResponder: &#39;LoginTutorial.statechart&#39;,

    //...
  })
})</code></pre>

<p>Update the button view like this:</p>

<pre><code>loginButton: SC.ButtonView.design({
    layout: { width: 100, height: 30, top: 120, centerX: 0 },
    conrolSize: SC.HUGE_CONTROL_SIZE,
    title: &#39;Login&#39;,
    action: &#39;authenticate&#39;
  })</code></pre>

<p>Now add a method in the state chart to handle the action</p>

<pre><code>LoginTutorial.statechart = SC.Statechart.create({
  rootState: SC.State.design({
    initialSubstate: &#39;loggedOut&#39;,

    loggedOut: SC.State.design({
      enterState: function() {
        LoginTutorial.getPath(&#39;loginPage.mainPane&#39;).append();
      },

      exitState: function() {
        LoginTutorial.getPath(&#39;loginPage.mainPane&#39;).remove();
      },

      authenticate: function() {
        // we&#39;ll fill this in later
        // you can call alert(&#39;weeeeee&#39;) to test it&#39;s working if you 
        // don&#39;t trust me :D
      }
    }),

    loggedIn: SC.State.design({
      enterState: function() {
        LoginTutorial.getPath(&#39;mainPage.mainPane&#39;).append();
      }
    })
  })
});</code></pre>

<h2 id='mock_authentication'>Mock Authentication</h2>

<p>At this point we can check the credentials in the authenticate method we just added. For now we&#8217;ll just check to see if the user has filled in both things, then move to logged in state. We&#8217;ll show an error if either value is missing. Once the UI working, we&#8217;ll use a simple web service to authenticate.</p>

<pre><code>authenticate: function() {
    var userName = LoginTutorial.getPath(&#39;loginController.userName&#39;);
    var password = LoginTutorial.getPath(&#39;loginController.password&#39;);

    if(!SC.empty(userName) &amp;&amp; !SC.empty(password)) {
      this.gotoState(&#39;loggedIn&#39;);
    } else {
      SC.AlertPane.error(&quot;Login information incorrect!&quot;);
    }
  }</code></pre>

<p>Now, when you fill in both fields and press login, then you should see the original welcome message. Otherwise, you get a popup error message.</p>

<p><img alt='Error Message' src='/images/posts/sproutcore_login_tutorial/error.png' /></p>

<h2 id='connecting_to_the_web'>Connecting to the Web</h2>

<p>Now we&#8217;ll create a simple sinatra site that accepts a post and does the same basic checking. Here is <code>webservice.rb</code>:</p>

<pre><code>require &#39;rubygems&#39;
require &#39;sinatra&#39; # make sure you install this gem
require &#39;json&#39; # make sure you install this gem

post &#39;/login&#39; do
  data = JSON.parse request.body.read

  if data[&#39;user_name&#39;] &amp;&amp; data[&#39;password&#39;]
    200
  else
    412
  end
end</code></pre>

<p>Sproutcore sends parameters as JSON encoded strings. We need to decode the JSON to get the parameters. Now you can run the file like this:</p>

<pre><code>$ ruby webservice.rb</code></pre>

<p>Now we have to update the authenticate method to post data to the server:</p>

<pre><code>loggedOut: SC.State.design({
  enterState: function() {
    LoginTutorial.getPath(&#39;loginPage.mainPane&#39;).append();
  },

  exitState: function() {
    LoginTutorial.getPath(&#39;loginPage.mainPane&#39;).remove();
  },

  authenticate: function() {
    var userName = LoginTutorial.getPath(&#39;loginController.userName&#39;);
    var password = LoginTutorial.getPath(&#39;loginController.password&#39;);

    SC.Request.postUrl(&#39;/login&#39;, {user_name: userName, password: password}).
      notify(this, &#39;didCompleteAuthentication&#39;).json().send();
  },

  didCompleteAuthentication: function(response){
    if(SC.ok(response)) {
       this.gotoState(&#39;loggedIn&#39;);
     } else {
       SC.AlertPane.error(&quot;Login information incorrect!&quot;);
     } 
  }
}),</code></pre>

<p>We use <code>SC.Request</code> to create a HTTP POST ajax call. The second argument is the body. Calling .json() will encode the body argument when sending the request. notify() adds a callback to handle the response. Finally, send() actually sends the request. The first argument to the callback is always the response. We check to see if it&#8217;s ok then go to logged in state, else show an error message.</p>

<p>Finally, we have to update the build file to proxy &#8216;/login&#8217; to sinatra. Add this line to your <code>Buildfile</code>:</p>

<pre><code>proxy &#39;/login&#39;, :to =&gt; &#39;localhost:4567&#39;</code></pre>

<h2 id='wrapping_up'>Wrapping Up</h2>

<p>I moved through this example pretty fast since it&#8217;s very basic. It is intended to give you a rough overview of how you can string together a controller, view, state chart, an web service to authenticate users and update the UI accordingly. Here is some further reading:</p>

<ul>
<li><a href='http://github.com/Adman65/sproutcore-login-tutorial'>Source</a></li>

<li><a href='http://blog.nextfinity.net/loginlogout-example-app-pt-1/'>More detailed login tutorial</a></li>

<li><a href='http://wiki.sproutcore.com/w/page/12412900/Foundation-Ajax%20Requests'>SC.Request</a></li>

<li><a href='http://frozencanuck.wordpress.com/2010/11/15/ki-now-the-official-statechart-framework-for-sproutcore/'>More about statecharts in SC</a></li>

<li><a href='http://guides.sproutcore.com'>Sproutcore Guides</a></li>

<li><a href='http://www.sinatrarb.com/intro.html'>More about Sinatra</a></li>
</ul>

          <h3>Contact Me</h3>
          <p>
            Find a problem or have a question about this post? <a href="http://twitter.com/adman65/">@adman65</a> on
            Twitter or Adman65 on #freenode. Find me in (#rubyonrails or
            #sproutcore). You can find my code on <a href="http://github.com/twinturbo/">GitHub</a> or hit me up on
            <a href="https://plus.google.com/u/0/116377228668850173159">Google+</a>.
          </p>
        </article>
      </div>
    </div>

    <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4eb0f672613f5d482f000001');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

  </body>
</html>
