<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>BroadcastingAdam - Why I Love Volume 1: Sprockets</title>

    <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.2r1/build/reset/reset-min.css">
<link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />


    <script type="text/javascript" src="http://yandex.st/highlightjs/5.16/highlight.min.js"></script>
    <link rel="stylesheet" href="http://yandex.st/highlightjs/5.16/styles/github.min.css">
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="container">
      <header>
  <h1>BroadcastingAdam</h1>
  <a href="http://feeds.feedburner.com/BroadcastingAdam" id="rss"><img src="images/rss_icon.png" alt="rss" /></a>
  <nav>
    <a href="/">Home</a>
    <a href="/nettuts.html">Nettuts</a>
    <a href="/talks.html">Talks</a>
    <a href="/open_source.html">Open Source</a>
  </nav>
</header>


      <div id="content" class="post">
        <header >
          <h2>Why I Love Volume 1: Sprockets</h2>
          <div class='meta'>
            </p>February 11, 2011 &nbsp; | &nbsp; ruby javascript gems</p>
          </div>
        </header>
        <article>
          <p><a href='http://getsprockets.org/'>Sprockets</a> is one of the most handy gems I&#8217;ve ever used. It allows you separate javascript into multiple files and use <code>require</code> keywords. This was a god send for me. The application I&#8217;m working has a TON of js. I was able to tame it with sprockets. I also came up with a nice directory structure a long the way.</p>

<h2 id='the_problem'>The Problem</h2>

<p>It all starts with application.js. You have one file. The documentation says dump your javascript into this file&#8211;hell, put <strong>all</strong> your js into this file. So you start writing a few ajax calls and various trickery. 20 lines. Then 50 lines. Then 100 lines. Then 500 lines. Then maybe a couple thousand. Wait&#8230;.a couple thousand? How did we get here? A couple thousand for what? What page is this JS for? How do i <em>find</em> what javascript I&#8217;m looking for? Hmmm. What about my jquery plugins? /public is starting to get pretty packed. Now lets say you&#8217;ve got 25 different pages. Each page needs their own JS to accomplish certain tasks. At this point, is it smart to keep dumping things into the same file? I say no. It&#8217;s time to get things whipped into shape. There&#8217;s one thing I really like about Rails: <strong>convention over configuration.</strong> The views folder is setup pretty nicely. There is a folder that corresponds to the controller that renders the view, and a file for the view name. It would be nice to have this same structure for our javascript. When your JS starts to become rather large, you&#8217;ll have some common code that is shared. This stuff belongs in an application.js file. So how can we keep all this code organized? Sprockets.</p>

<h2 id='hail_the_conquering_hero'>Hail the Conquering Hero</h2>

<p>Sprockets is a Ruby library that preprocesses and concatenates JavaScript source files. It takes any number of source files and preprocesses them line-by-line in order to build a single concatenation. Specially formatted lines act as directives to the Sprockets preprocessor, telling it to require the contents of another file or library first or to provide a set of asset files (such as images or stylesheets) to the document root. Sprockets attempts to fulfill required dependencies by searching a set of directories called the load path.</p>

<p>Perfect. It can even combine all our js into one single file. We can even minmize that later if we choose too. This means we can setup this type of directory structure:</p>

<pre><code>/app
  /javascripts
    /pages
      dashboard.js
      settings.js
    /shared
      utility.js
    application.js</code></pre>

<p>! That is pretty handy if you ask me. It becomes very odvious how the JS is organized. It also makes it very easy to add isolated bits of javascript for specific pages/widgets/etc. You can also add other directories to the load path. This means you can create a /vendor directory for your javascript. I love this because I can keep my downloaded jquery plugins in /vendor with git submodules for easy updating. So you could create this sort of structure for your application:</p>

<pre><code>/app
  /javascripts
    /so_on_and_so_forth
/vendor
  /javascripts
    jquery.js
    jquery-ui.js
    jquery.plugin1.js
    jquery.plugin2.js</code></pre>

<p>Nice. You can also require other files as you would in ruby. For example, say you&#8217;re in application.js and you want to ensure that some other javascript (like jquery) is loaded before this code is ran.</p>

<pre><code>//=require &lt;jquery&gt;

// jquery dependent stuff here</code></pre>

<p>Another example, say you&#8217;re writing some JS for the dashboard and you need to the utilities methods.</p>

<pre><code>//= require &#39;../shared/utilities&#39;

MyApp.utilities.flashNotice(&#39;oh hai&#39;);</code></pre>

<p>A require statement tells Sprockets to insert the content of the required file before processing the rest of the document. I like this because it makes it very explicit what JS is needed. It also prevents those wonderful undefined method xxx for null errors. A require with <code>&lt;file&gt;</code> tells sprockets to search the load path. A require without means it is a relative path name.</p>

<h2 id='how_i_integrated_sprockets'>How I Integrated Sprockets</h2>

<p>I took a similar approach to what I outlined earlier. I wanted a javascript file for each separate page of the application and a some shared folder where shared code lived. Then I wanted a way to easily initialize the pages. Each page would live in it&#8217;s own specific object, so there would be no collisions. Here is the directory structure I came up with:</p>

<pre><code>/app
  /javascripts
    /pages
      dashboard.js
      settings.js
    /components
      widget1.js
      widget2.js
    /shared
      utilities.js
    application.js
    jquery.js
/vendor
  /sprockets
    /jquery
      /src
        jquery-1.4.4.js
        jquery-ui.js
        jquery.plugin1.js
        jquery.plugin2.js</code></pre>

<p>My application has many shared widgets. I called them components because they can be reused in any context in many different places. Sometimes the JS for these things can be quite long, so I wanted a specific file for each one so I knew where to look when something went wrong. The default configuration for sprocket-rails has <code>/vendor/sprockets/*src</code> on the load path. I didn&#8217;t feel like changing it, and this way it lets me group similar files. Sprockets will always process application.js first. I use this to set the stage by requiring all different JS my application needs.</p>

<pre><code>// application.js

//=require &#39;jquery&#39;</code></pre>

<p>jquery.js is a file simple loads all the stuff in /vendor:</p>

<pre><code>// jquery.js

//=require &lt;jquery.1.4.4.&gt;
//=require &lt;jquery-ui&gt;
//=require &lt;jquery.plugin1&gt;
//=require &lt;jquery.plugin2&gt;</code></pre>

<p>Here&#8217;s what one of the page file looks like:</p>

<pre><code>//= require &#39;../components/widget1.js&#39;
//= require &#39;../components/widget2.js&#39;

var DashboardPage = {
  init: function() {
      // do stuff, this is called when the page is loaded
  },
  // protip, use an ajax callback for the page automagically
  ajaxComplete: function() { }
};</code></pre>

<p>I added a helper to initialize the page and attach the current page. It generates javascript like along these lines and embeds it into the page:</p>

<pre><code>$(function(){
  #{page_name.titleize}Page.init();
  $(&#39;body&#39;).ajaxComplete(#{page_name.titleize}Page.ajaxComplete);
});</code></pre>

<p>Then in the view (/app/views/dashboards/show):</p>

<pre><code>&lt;% initialize_page &#39;dashboard&#39; %&gt;</code></pre>

<h2 id='how_it_worked_out'>How it Worked Out</h2>

<p>This was the best changed I&#8217;ve ever made to this application. Before the JS was spread out into random files and it was a pain in the ass to track down <em>how</em> it got included and <em>where</em> it was. Now this way I know there is /app/javascripts/pages/page_name.js file and by the time that code is executed, all the required code is added. It&#8217;s also been very easy to add new plugins. Drop the jquery plugin into /vendor and update the jquery.js in /app/javascripts. Boom. Available everywhere. It is also concatenated into one large file so instead of 20 or so (yes I know this is bad) requests we now only have <strong>1</strong>. This made a big difference in the load time. If you haven&#8217;t used sprockets, I highly suggest you check it out&#8211;especially if you have a js centric application.</p>

<p><strong>tl;dr</strong>: Sprockets is a cool gem to organize and manage js your own way. It also concatenates all js files into one single file. This makes your page load faster. Use sprockets for inceased sanity.</p>

          <h3>Contact Me</h3>
          <p>
            Find a problem or have a question about this post? <a href="http://twitter.com/adman65/">@adman65</a> on
            Twitter or Adman65 on #freenode. Find me in (#rubyonrails or
            #sproutcore). You can find my code on <a href="http://github.com/twinturbo/">GitHub</a> or hit me up on
            <a href="https://plus.google.com/u/0/116377228668850173159">Google+</a>.
          </p>
        </article>
      </div>
    </div>

    <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4eb0f672613f5d482f000001');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

  </body>
</html>
