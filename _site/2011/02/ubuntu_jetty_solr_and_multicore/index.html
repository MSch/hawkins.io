<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Ubuntu, Jetty, Solr & MultiCore</title>
    <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.2r1/build/reset/reset-min.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
    <script type="text/javascript" src="http://yandex.st/highlightjs/5.16/highlight.min.js"></script>
    <link rel="stylesheet" href="http://yandex.st/highlightjs/5.16/styles/github.min.css">
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-6388387-1']);
      _gaq.push(['_setDomainName', 'broadcastingadam.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <div id="container" class='no-header'
      <header>
        <nav>
          <a href="/">Home</a>
          <a href="/nettuts.html">Nettuts</a>
        </nav>
      </header>
      <div id="content" class="post">
        <header >
          <h2>Ubuntu, Jetty, Solr & MultiCore</h2>
          <div class='meta'>
            </p>February 02, 2011 &nbsp; | &nbsp; ruby javascript gems</p>
          </div>
        </header>
        <article>
          <p><a href='http://lucene.apache.org/solr/'>Solr</a> is a wonderful fulltext search program. It can be configured to do a great many things. It can also be a royal pain to setup. Solr is written in Java. In order to use solr in your application you must configure a java application somewhere to serve up Solr. Solr runs as an web service. You index docouments by posting XML to the server for indexing. You can install a java application server like Tomcat or Jetty to host Solr. By default, Solr can only index one set of data. This means, if you need to host multiple applications on the same solr server, then you have a few options. You can create new Solr instances for each application, or you can use Solr&#8217;s MultiCore functionality to index different datasets. MultiCore is like creating another database for Postgres. I&#8217;ll show you how to get this up and running under Ubuntu.</p>

<h2 id='installing_jetty_java_and_solr'>Installing Jetty, Java and Solr.</h2>

<p>This is one of the reasons I love ubuntu server. It just has packages. I don&#8217;t have to worry about downloading code from random place, it just has everything a boy could need in a server. Install these packages using apt:</p>

<pre><code>sudo apt-get install solr-jetty openjdk-6-jdk</code></pre>

<p>This pulls in ~60MB and a ton of packages so watch out for that :D</p>

<p>The next thing we want to do is setup Jetty to listen on all connections. By default the installation is only available on htt://localhost:8080. That&#8217;s great if you&#8217;re making a local server, but we need to open our box up to the world. Ubuntu uses a file <code>/etc/defaults/jetty</code> to manage daemon settings. Open this file in vim and replace this line:</p>

<pre><code>#JETTY_HOST=$(uname -n)</code></pre>

<p>With:</p>

<pre><code>JETTY_HOST=</code></pre>

<p>This will tell jetty to listen on all connections. You can also put in your own ip or domain name if you please. Feel free to change the port as well at this point.</p>

<p>Now navigate to the top of the file and <code>/NO_START</code> to go to the next setting we need to change. Replace the 1 with a 0 and wer&#8217;re in business. This will tell jetty to start when the server is loaded.</p>

<p>Now fire the server up with:</p>

<pre><code>/etc/init.d/jetty start</code></pre>

<p>Once all is good you should be able to navigate to <a href='http://yourhost.com:8080'>http://yourhost.com:8080</a> and get welcome page. This is basically a &#8220;it works page&#8221;. Now you can move on to solr. Ubuntu already did a lot of extra work for you by installing a runnable version of solr into Jetty. You can access that at <a href='http://yourhost.com:8080/solr'>http://yourhost.com:8080</a>. It is a very basic admin&#8211;but it&#8217;s something. Now we&#8217;re ready for MulitCore.</p>

<h2 id='multi_core'>Multi Core</h2>

<p>MultiCore is was the most complicated part for me to get setup, partially because everything I read conflicted with something&#8211;but don&#8217;t worry. It should be easy for you if you follow along. You can read the offical wiki page <a href='here'>http://wiki.apache.org/solr/CoreAdmin</a>.</p>

<p><strong>Here&#8217;s what they don&#8217;t tell you, or assume you should know:</strong> In order for MultiCore to work, each core must have it&#8217;s own solrconfig.xml and schema.xml. That&#8217;s fantastic, but excuse me, where the hell do I put these files? That was my life for 3 hours. Mucking around with random configurations until POOF. \o/ It all worked.</p>

<p>You also have to create a <code>solr.xml</code> file separate from all the other config files that tells Solr to load multicore. This was outlined reasonably well in the documentation, but it still gave me headaches.</p>

<h3 id='step_1_solrxml'>Step 1. Solr.xml</h3>

<p>We need to create a file that tells Solr to load our cores. You can decided ahead of time what they are, or just use this as a template for now. Below is a template you can follow. You can create as many cores as you want. When Editing the file, be sure to replace all copies of &#8220;production&#8221; with whatever the name of your core is. In my setup, I needed 3 different cores. One for production code, one for staging code, and one for a beta code. Once you&#8217;ve created this file, save it as: <strong>/usr/share/solr/solr.xml</strong>.</p>

<pre><code>&lt;solr persistent=&quot;true&quot;&gt;
 &lt;cores adminPath=&quot;/admin/cores&quot;&gt;
   &lt;core name=&quot;production&quot; instanceDir=&quot;production&quot; dataDir=&quot;/var/lib/solr/production/data&quot; /&gt;
   &lt;core name=&quot;staging&quot; instanceDir=&quot;staging&quot; dataDir=&quot;/var/lib/solr/staging/data&quot; /&gt;
   &lt;core name=&quot;beta&quot; instanceDir=&quot;beta&quot; dataDir=&quot;/var/lib/solr/beta/data&quot; /&gt;
 &lt;/cores&gt;
&lt;/solr&gt;</code></pre>

<p><strong>Don&#8217;t forget to set the dataDirectory attribute as well!</strong></p>

<h3 id='step_2_making_data_directories'>Step 2. Making Data Directories</h3>

<p>Now we must create directories for our index data to live. They were specified earlier in the step 1. These directories must be writable by the jetty user. Apt automatically added this user for you when you installed jetty-solr. You can create them with this command.</p>

<pre><code>sudo mkdir -p /var/lib/solr/production/data</code></pre>

<p>Repeat this command for however many cores you need. Next make jetty the owner.</p>

<pre><code>sudo chown -R jetty /var/lib/solr/</code></pre>

<h3 id='step_3_copying_the_config_files'>Step 3. Copying the Config Files</h3>

<p>This was the hidden step. First thing we need to do is create directories for our cores to live. Each core has it&#8217;s own schema and config files. These need to be created. It&#8217;s just like we did in step 2, but with a different directory.</p>

<pre><code>sudo mkdir /usr/share/solr/production</code></pre>

<p>Now we need to create the configuration files. I&#8217;ve posted them in gists. These files are templates and just enough to get the server started. It is up to you to do the customization!</p>

<ul>
<li><a href='https://gist.github.com/816101'>solrconfig.xml</a></li>

<li><a href='https://gist.github.com/816103'>schema.xml</a></li>
</ul>

<p>Download those files or keep them open. Now create a conf directory inside the directory you&#8217;ve already created</p>

<pre><code>sudo mkdir /usr/share/solr/production/conf</code></pre>

<p>Now enter the directory and paste those files.</p>

<pre><code>cd /usr/share/solr/production/conf
# paste solrconfig.xml into your editor and save it
# paste schema.xml into your editor and save it</code></pre>

<p>Now at this point, you can simply copy this directory for the other stages. This is especially helpful if you have 5 stages. You can duplicate the config like so</p>

<pre><code>sudo cp -R /usr/share/solr/production /usr/share/solr/new_name1
sudo cp -R /usr/share/solr/production /usr/share/solr/new_name2
# and so on</code></pre>

<p>Now you are ready to restart the server</p>

<pre><code>sudo /etc/init.d/jetty stop
sudo /etc/init.d/jetty start</code></pre>

<p>Now head back over to <a href='http://yourhost.com:8080/solr/admin'>http://yourhost.com:8080/solr/admin</a> And you should see links to all your cores!</p>

<h3 id='step_4_customization'>Step 4. Customization</h3>

<p>Depending your needs you may have different schemas and configurations for each core. You should configure them now. If you need to use the same configuration to each core, you should symlink the main solrconfig.xml to the various stages. For example, you should have the production and staging cores running the same config.</p>

<p>Feel free to hit me up on twitter at @Adman65 with questions or problems! Hope this helped.</p>

          <h3>Contact Me</h3>
          <p>
            Find a problem or have a question about this post? <a href="http://twitter.com/Adman65/">@Adman65</a> on
            Twitter or Adman65 on #freenode. Find me in (#rubyonrails or
            #sproutcore). You can find my code on <a href="http://github.com/Adman65/">GitHub</a>
          </p>
        </article>
      </div>
    </div>

    <script type="text/javascript">
      var _gauges = _gauges || [];
      (function() {
        var t   = document.createElement('script');
        t.type  = 'text/javascript';
        t.async = true;
        t.id    = 'gauges-tracker';
        t.setAttribute('data-site-id', '4eb0f672613f5d482f000001');
        t.src = '//secure.gaug.es/track.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(t, s);
      })();
    </script>
  </body>
</html>
